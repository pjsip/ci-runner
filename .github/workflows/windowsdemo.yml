name: Windows Demo
on:
  push
jobs:
  success-case:
    runs-on: windows-latest
    name: Successful case
    steps:
    - uses: actions/checkout@master
    - name: install cirunner infrastructure
      run: .\installwindows.ps1
    - name: build testapp
      run: |
        call "%PROGRAMFILES%\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
        cl.exe /nologo /Od /Zi testapp.c
      shell: cmd
    - name: running test program
      run: python winrunner.py -- testapp.exe -t 5

  crash-case:
    runs-on: windows-latest
    name: Crash case
    steps:
    - uses: actions/checkout@master
    - name: install cirunner infrastructure
      run: .\installwindows.ps1
    - name: build testapp
      run: |
        call "%PROGRAMFILES%\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
        cl.exe /nologo /Od /Zi testapp.c
      shell: cmd
    - name: running test program
      run: |
        # Runner will return non-zero if the test program fails, and this will fail the job.
        # So use commands below to save return value to $ret and set $lastexitcode to 0.
        python winrunner.py -t 60 -- testapp.exe -t 5 -c; $ret=$lastexitcode; cmd /C exit 0
        if ($ret -eq 0) {
          cmd /C exit 777
        }

  timeout-case:
    runs-on: windows-latest
    name: Timeout case
    steps:
    - uses: actions/checkout@master
    - name: install cirunner infrastructure
      run: .\installwindows.ps1
    - name: build testapp
      run: |
        call "%PROGRAMFILES%\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat"
        cl.exe /nologo /Od /Zi testapp.c
      shell: cmd
    - name: running test program
      run: |
        # Runner will return non-zero if the test program fails, and this will fail the job.
        # So use commands below to save return value to $ret and set $lastexitcode to 0.
        python winrunner.py -t 5 -- testapp.exe -t 60; $ret=$lastexitcode; cmd /C exit 0
        if ($ret -eq 0) {
          cmd /C exit 777
        }
